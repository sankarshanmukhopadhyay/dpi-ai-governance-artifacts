# Migration Guide — v0.5.0 → v0.6.0

This guide explains what changed in **v0.6.0** and what implementers need to update when migrating from **v0.5.0**.

## Summary of what changed

### 1) Decision receipts now support and conditionally require lawful basis
- `schemas/decision-receipt.schema.json` now includes a top-level `lawful_basis` field (ref: `schemas/lawful-basis.schema.json`).
- **New enforcement rule:** if `decision.risk_tier` is **tier2** or **tier3** and `subject.subject_type` is **person**, then `lawful_basis` is **REQUIRED**.

**Impact:** Tier2/Tier3 services that decide about natural persons must emit lawful basis data in receipts (or validation will fail).

### 2) Shared schema primitives consolidated in `common-defs.schema.json`
`schemas/common-defs.schema.json` defines reusable primitives (identifier, timestamp, signature, hash, jurisdiction, reason_code).

**Impact:** New and updated schemas may reference these definitions via `$ref`. If you maintain custom schemas, prefer referencing `$defs` rather than redefining primitives.

### 3) Vendor attestation test vectors added
`rulebook-test-vectors/vendor-attestation/` now contains:
- `valid-basic.json`
- `valid-high-assurance.json`
- `invalid-missing-assurance.json`
- `invalid-missing-signature.json`

**Impact:** Vendor attestation producers can use these as known-good / known-bad fixtures; validators can use them to lock behavior.

### 4) CI validation expanded
The schema validation workflow validates the repository’s schema/examples continuously.

**Impact:** Schema or template edits that introduce invalid JSON or schema drift will fail CI.

---

## Required migration actions (practical checklist)

### A. Update decision receipt emission (Tier2/Tier3 + persons)
If your receipts include:
- `decision.risk_tier = "tier2"` or `"tier3"`
- and `subject.subject_type = "person"`

You **must** add:

```json
"lawful_basis": {
  "basis_type": "public_task",
  "jurisdiction": "IN",
  "valid_from": "2026-02-22T00:00:00Z",
  "authority_reference": "…",
  "evidence_hash": "…"
}
```

Choose the appropriate `basis_type` for your jurisdiction and program context.

### B. Update schema references if you extend the repo
If you maintain internal overlays:
- Prefer `$ref` to `schemas/common-defs.schema.json#/$defs/...` for primitives.
- Keep `$schema` and JSON Schema draft aligned with repo conventions.

### C. Validate locally before pushing
```bash
python -m pip install jsonschema
python tools/validate_schemas.py
```

---

## Compatibility notes

- v0.6.0 is a **validation-tightening** release. Existing Tier0/Tier1 receipts are typically unaffected.
- Tier2/Tier3 receipts about natural persons may fail validation until `lawful_basis` is included.

---

## Quick troubleshooting

- **CI fails on decision receipts:** confirm `lawful_basis` is present when required.
- **CI fails on custom schema overlays:** migrate primitive fields to `common-defs.schema.json` references.
